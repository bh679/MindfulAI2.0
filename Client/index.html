<!DOCTYPE html>
<html data-wf-domain="">
    <head>
        <script src="./js/recorder.js"></script>
        <script src="./js/AskGPTClient.js"></script>
        <script src="./js/API/ElevenLabsClient.js"></script>
        <script src="./js/LanguageManager.js"></script>
        <script src="./js/GalleryDataManager.js"></script>
        <script src="./js/GalleryManager.js"></script>
        <script src="./js/MindfulAIApp.js"></script>
    </head>
    <body class="body">

        <!-- Button to start and stop recording -->
        <button id="recordButton">Start Recording</button>

        <!-- Divs to display the status message and the transcription -->
        <div id="statusMessage"></div>
        <div id="transcription"></div>

        <script>



            //https://chat.openai.com/share/ca60ea94-5709-4675-8563-96d220fa6b52
            window.onload = function() {
                // Get the elements from the page
                const apiKeyInput = document.getElementById('apiKey');
                const recordButton = document.getElementById('recordButton');
                const statusMessage = document.getElementById('statusMessage');
                const transcriptionDiv = document.getElementById('transcription');

                // Create a new Recorder object
                const recorder = new Recorder(apiKeyInput, statusMessage);

                // When the record button is clicked
                recordButton.onclick = function() {
                    RecordToText();
                    buttonPressHandler();
                };

                async function RecordToText() {

                    recordButton.innerText = 'Stop Recording';

                    //start/stop reocrding
                    recorder.toggleRecording(FinishRecording);
                    
                }

                async function FinishRecording(recordingChunk)
                {
                    //update button
                    recordButton.innerText = 'Start Recording';

                    //transcribe results
                    var transcript = await transcribe(recordingChunk);

                    //save transcription
                    transcriptionDiv.innerText = transcript;

                    app.UserTalk(transcript);
                }

                const apiDomain = 'https://mindfulai.equalreality.com:3000';

                // Define the transcribe function, which sends audio chunks to the Whisper API and fetches the transcription
                async function transcribe(chunk) {
                    // Log the chunks data to the console for debugging purposes
                    console.log(chunk);

                    // Create a new Blob object from the first chunk (which should contain the audio data)
                    const audioData = new Blob([chunk], { type: 'audio/webm' });

                    // Create a new FormData object
                    const formData = new FormData();

                    // Append the Blob object to the FormData object under the key 'file'
                    formData.append('file', audioData, 'audio.wav');

                    // Send a POST request to the Whisper API with the FormData object in the body
                    const response = await fetch(apiDomain + '/Transcribe', {
                        method: 'POST',
                        body: formData
                    });

                    // If the response status is not OK (200), throw an error with the status
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Parse the response body as JSON
                    const data = await response.json();

                    // If the transcription is still processing, throw an error
                    if (data.message === 'Transcription is still processing') {
                        throw new Error('Transcription is still processing');
                    }

                    // If there was an error during transcription, throw an error with the error message
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Log the transcription to the console for debugging purposes
                    console.log(`Transcription: ${data.transcription}`);

                    // Return the transcription
                    return data.transcription;
                }


                // Check server status on page load
                    checkServerStatus();

                    async function checkServerStatus() {
                        try {
                            const response = await fetch(apiDomain + '/ping');
                            const data = await response.json();
                            
                            if (data.status === 'Server is running!') {
                                console.log("Server is up and running");
                                // Optionally, you can display a message or change some UI element to show server status.
                            }
                        } catch (error) {
                            console.error("Server seems to be down:", error);
                            // Here, you can also display a warning to the user about the server being down or handle it in another appropriate way.
                        }
                    }

            };
        </script>
    </body>
</html>
